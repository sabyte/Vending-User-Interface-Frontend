let id_token;

// Step 1: Get the id_token
$.ajax({
    url: 'https://tokenized.pay.bka.sh/v1.2.0-beta/tokenized/checkout/token/grant',
    type: 'POST',
    contentType: 'application/json',
    data: JSON.stringify({
        app_key: 'Pc0yKAFRbzf6N3yk9msFYs8Ttc',  // Replace with your live app key
        app_secret: 'LNHBzWWQliD4uLzxvSRNHFNFFUrIeCTptabBuNIPtAIfDKVEbK0c',  // Replace with your live app secret
        username: '01619754538',  // Replace with your live username
        password: '-2E8SmJlB{t'  // Replace with your live password
    }),
    success: function(response) {
        id_token = response.id_token;
        console.log('Token granted:', id_token);

        // Now create the payment
        createPayment();
    },
    error: function(xhr) {
        console.error('Error getting access token:', xhr.responseText);
        alert('Failed to get access token. Please check the console for more details.');
    }
});

// Step 2: Create the Payment
function createPayment() {
    $.ajax({
        url: 'https://tokenized.pay.bka.sh/v1.2.0-beta/tokenized/checkout/create',
        type: 'POST',
        contentType: 'application/json',
        headers: {
            'Authorization': 'Bearer ' + id_token,
            'X-APP-Key': 'Pc0yKAFRbzf6N3yk9msFYs8Ttc'  // Replace with your live app key
        },
        data: JSON.stringify({
            "mode": "0011",
            "payerReference": "01723888888",  // Replace with actual payer reference
            "callbackURL": "http://yourdomain.com",  // Replace with your actual callback URL
            "merchantAssociationInfo": "MI05MID54RF091234560ne",  // Replace with your actual info
            "amount": "500",  // Replace with actual amount
            "currency": "BDT",
            "intent": "sale",  // Change to "authorization" if required
            "merchantInvoiceNumber": "Inv0124"  // Replace with actual invoice number
        }),
        success: function(data) {
            console.log('Payment Created:', data);
            window.location.href = data.bkashURL;  // Redirect to the bKash payment page
        },
        error: function(xhr) {
            console.error('Error creating payment:', xhr.responseText);
            alert('Failed to create payment. Please check the console for more details.');
        }
    });
}
